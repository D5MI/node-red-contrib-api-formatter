<script type="text/javascript">
  (function () {
    let treeList;
    let tree = [];
    let paths = [];

    RED.nodes.registerType("data-path-generator", {
      category: "Data Extraction",
      color: "#00bffe",
      defaults: {
        name: {
          value: "Data Path Generator",
        },
        url: {
          value: "",
        },
      },
      icon: "font-awesome/fa-list-ul",
      paletteLabel: "Data Path Generator",
      label: function () {
        return "Data Path Generator";
      },
      oneditsave: function () {
        this.tree = tree;
        this.paths = paths;
      },
      oneditprepare: function () {
        $("#node-input-read").on("click", function () {
          fetch($("#node-input-url").val())
            .then(function (response) {
              return response.json();
            })
            .then(function (json) {
              tree = [];
              makeKeyTree(json, tree);
              treeList.treeList("data", tree);
            })
            .catch((error) => {
              console.log(error);
            });
        });

        treeList = $("<div>")
          .css({ width: "100%", height: "100%" })
          .appendTo(".node-input-api-tree")
          .treeList({});

        if (this.tree !== undefined) {
          tree = this.tree;
          treeList.treeList("data", tree);
        }
        if (this.paths !== undefined) {
          paths = this.paths;
          showPath();
        }

        treeList.on("treelistselect", function (event, item) {
          if (item === undefined || Object.keys(item).length === 0) {
            return;
          }

          if (item.selected) {
            if (item.parent !== undefined) {
              item.parent.treeList.select(true);
            }
          } else if (!item.selected) {
            if (item.children !== undefined) {
              for (n of item.children) {
                if (n.selected) {
                  n.treeList.select(false);
                }
              }
              return;
            }
          }

          paths = [];
          for (item of tree) {
            generatePath(item, "");
          }
          showPath();
        });
      },
    });

    function showPath() {
      let res = "";

      for (let path of paths) {
        res += path + "\n";
      }
      $("#node-input-path").val(res);
    }

    function generatePath(item, pre) {
      if (!item.selected) {
        return;
      }

      let cur = item.depth === 0 ? item.label : pre + "." + item.label;
      if (item.children === undefined) {
        paths.push(cur);
        return;
      }

      let childChecked = false;
      for (n of item.children) {
        if (n.selected) {
          childChecked = true;
          generatePath(n, cur);
        }
      }
      if (!childChecked) {
        paths.push(cur);
      }
    }

    function makeKeyTree(json, subtree) {
      if (Array.isArray(json) && json.length > 0) {
        makeKeyTree(json[0], subtree);
        return;
      }
      let keys = Object.keys(json);
      for (let key of keys) {
        subtree.push(makeTreeItem(key));
        if (typeof json[key] === "object" && json[key] !== null) {
          subtree[subtree.length - 1]["children"] = [];
          makeKeyTree(json[key], subtree[subtree.length - 1]["children"]);
        }
      }
    }

    function makeTreeItem(label) {
      return {
        label: label,
        checkbox: true,
        selected: false,
        expanded: true,
      };
    }
  })();
</script>

<script type="text/html" data-template-name="data-path-generator">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" /><br />
  </div>
  <div class="form-row">
    <label for="node-input-url"><i class="fa fa-globe"></i> Url</label>
    <input type="text" id="node-input-url" placeholder="Url" style="width: 60%" />
    <button type="button" class="red-ui-button" id="node-input-read">Read</button>
  </div>
  <div class="form-row">
    <label for="node-input-path"><i class="fa fa-bookmark"></i> Path</label>
    <textarea id="node-input-path" disabled style="height: 80px; width: 100%;"></textarea>
  </div>
  <div class="form-row node-input-api-tree" style="height: calc(80% - 40px);">
    <label for="node-input-api-tree"><i class="fa fa-key"></i></i> Key</label>
  </div>
</script>

<script type="text/html" data-help-name="data-path-generator">
  <p>A node that extracts some data you want from REST API response.</p>
</script>
