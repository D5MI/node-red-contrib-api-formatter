<script type="text/javascript">
  (function () {
    let treeList;

    RED.nodes.registerType("data-path-generator", {
      category: "Data Extraction",
      color: "#00bffe",
      defaults: {
        name: {
          value: "Data Path Generator",
        },
        url: {
          value: "Url",
        },
      },
      icon: "font-awesome/fa-list-ul",
      paletteLabel: "Data Path Generator",
      label: function () {
        return "Data Path Generator";
      },
      oneditprepare: function () {
        $("#node-input-read").on("click", function () {
          console.log($("#node-input-url").val());

          fetch($("#node-input-url").val())
            .then(function (response) {
              return response.json();
            })
            .then(function (json) {
              let tree = [];
              makeKeyTree(json, tree);
              treeList.treeList("data", tree);
            })
            .catch((error) => {
              console.log("get 요청 실패");
            });
        });

        treeList = $("<div>")
          .css({ width: "100%", height: "100%" })
          .appendTo(".node-input-api-tree")
          .treeList({});
      },
    });

    function makeKeyTree(json, subtree) {
      let keys = Object.keys(json);
      for (let key of keys) {
        subtree.push(makeTreeItem(key));
        if (Array.isArray(json[key])) {
          if (json[key].length < 1) break;
          subtree[subtree.length - 1]["children"] = [];
          makeKeyTree(json[key][0], subtree[subtree.length - 1]["children"]);
        } else if (typeof json[key] === "object" && json[key] !== null) {
          subtree[subtree.length - 1]["children"] = [];
          makeKeyTree(json[key], subtree[subtree.length - 1]["children"]);
        }
      }
    }

    function makeTreeItem(label) {
      return {
        label: label,
        checkbox: true,
      };
    }
  })();
</script>

<script type="text/html" data-template-name="data-path-generator">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
    <input type="text" id="node-input-name" placeholder="Name" /><br />
  </div>
  <div class="form-row">
    <label for="node-input-url"><i class="fa fa-globe" aria-hidden="true"></i> Url</label>
    <input type="text" id="node-input-url" placeholder="Url" style="width: 60%" />
    <button type="button" class="red-ui-button" id="node-input-read">Read</button>
  </div>
  <div class="form-row node-input-api-tree" style="height: calc(100% - 40px);"></div>
</script>

<script type="text/html" data-help-name="data-path-generator">
  <p>A node that extracts some data you want from REST API response.</p>
</script>
